{% extends "base.html" %}
{% block title %}Your Cart{% endblock %}
{% block content %}

<h2>Your Shopping Cart</h2>

<div class="cart-wrapper" style="display: flex; gap: 30px; align-items: flex-start; flex-wrap: wrap;">

  <!-- LEFT: Cart Items -->
  <div class="cart-items-column" style="flex: 1 1 65%; min-width: 300px;">
    {% if cart_items %}
      {% for item in cart_items %}
        <div class="cart-item" style="display: flex; margin-bottom: 20px; gap: 15px; background: white; border: 1px solid #e2dcd3; border-radius: 12px; padding: 20px;">
          <img src="{{ url_for('static', filename=item.image) }}" alt="{{ item.name }}" class="cart-item-image" style="width: 120px; height: auto;">
         <!-- Info and Controls as separate sections -->
<div class="cart-item-details" style="flex-grow: 1;">
  <h3 style="margin-bottom: 10px;">{{ item.name }} (Size: {{ item.size }})</h3>
  <p>Price: ${{ "%.2f"|format(item.price) }}</p>
  <p>Total: ${{ "%.2f"|format(item.total_price) }}</p>
</div>

<div class="cart-item-controls" style="min-width: 150px; text-align: center;">
  <p>Qty: {{ item.quantity }}</p>
  <form method="POST" action="{{ url_for('update_cart', product_id=item.id) }}" style="display: inline-block; margin: 5px;">
    <input type="hidden" name="size" value="{{ item.size }}">
    <input type="hidden" name="action" value="decrease">
    <button type="submit">−</button>
  </form>
  <form method="POST" action="{{ url_for('update_cart', product_id=item.id) }}" style="display: inline-block; margin: 5px;">
    <input type="hidden" name="size" value="{{ item.size }}">
    <input type="hidden" name="action" value="increase">
    <button type="submit">+</button>
  </form>
  <form method="POST" action="{{ url_for('remove_from_cart', product_id=item.id) }}" style="margin-top: 10px;">
    <input type="hidden" name="size" value="{{ item.size }}">
    <button type="submit">Remove</button>
  </form>
</div>
        </div>
      {% endfor %}
    {% else %}
      <p>Your cart is empty.</p>
      <form action="{{ url_for('products_page') }}" method="get">
        <button type="submit" class="btn-secondary">Start Shopping</button>
      </form>
    {% endif %}
  </div>

  <!-- RIGHT: Order Summary & Buttons -->
  {% if cart_items %}
  <div class="cart-summary-column" style="flex: 1 1 30%; max-width: 400px; ...">
    <h3>Order Summary</h3>
    <p>Subtotal: ${{ "%.2f"|format(subtotal) }}</p>
    <p>Shipping: ${{ "%.2f"|format(shipping) }}</p>
    <h3>Total: ${{ "%.2f"|format(total) }}</h3>

    <form action="{{ url_for('checkout') }}" method="get" style="margin: 15px 0;">
      <button type="submit" class="btn-primary" style="width: 100%;">Continue Checkout</button>
    </form>

    <form action="{{ url_for('products_page') }}" method="get">
      <button type="submit" class="btn-secondary" style="width: 100%;">Continue Shopping</button>
    </form>

    <div id="paypal-button-container" style="margin-top: 20px;"></div>
  </div>
  {% endif %}
</div>

<!-- Recommended Products BELOW -->
{% if cart_items %}
<div class="recommendations-row" style="margin-top: 40px;">
  <h3>You might like</h3>
  <div class="recommended-products" style="display: flex; flex-wrap: wrap; gap: 20px;">
    {% for product in recommended_products %}
      <div class="recommended-item" style="flex: 1 1 200px; border: 1px solid #e2dcd3; border-radius: 12px; padding: 15px; text-align: center;">
        <a href="{{ url_for('product_detail', product_id=product.id) }}">
          <img src="{{ url_for('static', filename=product.image) }}" alt="{{ product.name }}" style="width: 100%; height: auto; max-width: 200px; border-radius: 8px;">
          <p>{{ product.name }}</p>
          <p>${{ "%.2f"|format(product.price) }}</p>
        </a>
        <form method="POST" action="{{ url_for('add_to_cart', product_id=product.id) }}">
          <input type="hidden" name="size" value="{{ product.sizes[0] }}">
          <button type="submit" class="btn-primary" style="width: 100%;">Add to Cart</button>
        </form>
      </div>
    {% else %}
      <p>No recommendations available.</p>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- PayPal SDK + Logic -->
{% if cart_items %}
<script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD"></script>
<script>
  paypal.Buttons({
    style: {
      layout: 'vertical',
      color: 'gold',
      shape: 'rect',
      label: 'paypal',
      height: 55
    },
    createOrder: function(data, actions) {
      return actions.order.create({
        purchase_units: [{
          amount: {
            value: '{{ "%.2f"|format(total) }}'
          }
        }]
      });
    },
    onApprove: function(data, actions) {
      return actions.order.capture().then(function(details) {
        alert('✅ Transaction completed by ' + details.payer.name.given_name);
      });
    }
  }).render('#paypal-button-container');
</script>
{% endif %}

{% endblock %}
